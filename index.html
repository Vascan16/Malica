<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malica Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react"></script>

    <style>
        @media print {
            @page { margin: 1cm; size: A4; }
            html, body { width: 100%; height: 100%; margin: 0 !important; padding: 0 !important; overflow: visible !important; background-color: white !important; }
            body > * { display: none !important; }
            #root { display: block !important; }
            .print-container { display: block !important; position: static !important; width: 100% !important; height: auto !important; overflow: visible !important; font-family: sans-serif; font-size: 10px; color: black; background: white; }
            nav, header, main, .fixed, button, .no-print { display: none !important; }
            .avoid-break { page-break-inside: avoid; }
            .page-break { page-break-before: always; }
        }
        .print-container { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .report-table th, .report-table td { border: 1px solid #e2e8f0; padding: 4px 6px; }
        .report-table th { background-color: #f8fafc; font-weight: bold; text-transform: uppercase; font-size: 9px; }
        .code-block { font-family: 'Courier New', Courier, monospace; background-color: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px; white-space: pre-wrap; font-size: 9px; color: #334155; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, query, writeBatch, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBjoIbXZEELew5F1zVnYzUbStp0IfVAwgg",
          authDomain: "malicamanagerpro.firebaseapp.com",
          projectId: "malicamanagerpro",
          storageBucket: "malicamanagerpro.firebasestorage.app",
          messagingSenderId: "902764840464",
          appId: "1:902764840464:web:7ad08867d6c6593efd2c95",
          measurementId: "G-WDP7KK30QQ"
        };

        const appId = "malica-manager-v1";
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        const { 
            Users, History, PlusCircle, Trash2, TrendingDown,
            CreditCard, UserPlus, ArrowRightCircle, ArrowDownCircle, Calendar,
            Wallet, Calculator, CheckCircle2, Download,
            AlertTriangle, FileText, CheckSquare, Square, Lock, Info, Scale,
            ListOrdered, RefreshCcw, Save, Table, Grid, Printer, Bell, X,
            Crown, PiggyBank, Ghost, Medal, Dices, Eye, EyeOff, BarChart3, Pizza 
        } = lucideReact;

        const _appVitals = {
            a_key: atob("NTEyNA=="),
            e_key: atob("OTkxMQ=="),
            s_key: atob("Nzc3Nw==")
        };

        const ACCESS_CODE = _appVitals.a_key;
        const EDIT_CODE = _appVitals.e_key;
        const ADMIN_PIN = _appVitals.s_key;

        const money = (val) => Math.round((val + Number.EPSILON) * 100) / 100;

        const getMatrixValue = (entry, member, type) => {
            if (type === 'Z') return entry.type === 'adjustment' && entry.user === member ? (parseFloat(entry.amount) || 0) : 0;
            if (type === 'P') return entry.payer === member ? (parseFloat(entry.amount) || 0) : 0;
            if (entry.splitType === 'manual' && entry.manualAmounts) return parseFloat(entry.manualAmounts[member]) || 0;
            if (entry.participants && entry.participants.includes(member)) return (parseFloat(entry.amount) || 0) / entry.participants.length;
            return 0;
        };

        const calculateTitles = (members, balances, history) => {
            const titles = {}; 
            const addTitle = (member, titleObj) => {
                if (!titles[member]) titles[member] = [];
                titles[member].push(titleObj);
            };
            if (members.length < 2 || history.length === 0) return titles;
            const maxBal = Math.max(...Object.values(balances));
            if (maxBal > 0) {
                const mecen = members.find(m => balances[m] === maxBal);
                if (mecen) addTitle(mecen, { icon: Crown, label: 'Mecen', color: 'text-yellow-600', bg: 'bg-yellow-100 border-yellow-200' });
            }
            const minBal = Math.min(...Object.values(balances));
            if (minBal < 0) {
                const gorenjec = members.find(m => balances[m] === minBal);
                if (gorenjec) addTitle(gorenjec, { icon: PiggyBank, label: 'Gorenjec', color: 'text-rose-600', bg: 'bg-rose-100 border-rose-200' });
            }
            const paymentCounts = {};
            members.forEach(m => paymentCounts[m] = 0);
            history.forEach(e => { if (e.type !== 'adjustment' && e.payer) paymentCounts[e.payer] = (paymentCounts[e.payer] || 0) + 1; });
            const maxPayments = Math.max(...Object.values(paymentCounts));
            if (maxPayments > 0) {
                const bankomat = members.find(m => paymentCounts[m] === maxPayments);
                if (bankomat) addTitle(bankomat, { icon: CreditCard, label: 'Bankomat', color: 'text-blue-600', bg: 'bg-blue-100 border-blue-200' });
            }
            const participationCounts = {};
            members.forEach(m => participationCounts[m] = 0);
            history.forEach(e => { if (e.type !== 'adjustment' && e.participants) e.participants.forEach(p => participationCounts[p] = (participationCounts[p] || 0) + 1); });
            const minPart = Math.min(...Object.values(participationCounts));
            if (history.length > 2) {
                const duh = members.find(m => participationCounts[m] === minPart);
                if (duh) addTitle(duh, { icon: Ghost, label: 'Duh', color: 'text-slate-500', bg: 'bg-slate-200 border-slate-300' });
            }
            const absBalances = members.map(m => Math.abs(balances[m] || 0));
            const minAbs = Math.min(...absBalances);
            const zenMasters = members.filter(m => Math.abs(balances[m] || 0) === minAbs);
            zenMasters.forEach(m => addTitle(m, { icon: Scale, label: 'Zen', color: 'text-emerald-600', bg: 'bg-emerald-100 border-emerald-200' }));
            return titles;
        };

        const getMatlabCode = (history, members) => {
            const adjustments = history.filter(e => e.type === 'adjustment');
            const transactions = history.filter(e => e.type !== 'adjustment').reverse();
            const headerStr = `clc;\nclear all;\n`;
            const membersStr = `clani = {${members.map(m => `'${m}'`).join(', ')}};`;
            const zVector = members.map(m => adjustments.reduce((s, e) => s + (e.user === m ? e.amount : 0), 0).toFixed(2)).join(', ');
            const zStr = `Z = [${zVector}]; % Zaƒçetna stanja`;
            const pRows = transactions.length > 0 ? transactions.map(t => members.map(m => getMatrixValue(t, m, 'P').toFixed(2)).join(', ')) : [members.map(() => '0.00').join(', ')];
            const pStr = `P = [\n  ${pRows.join(';\n   ')}\n]; % Matrika Plaƒçil (P)`;
            const sRows = transactions.length > 0 ? transactions.map(t => members.map(m => getMatrixValue(t, m, 'S').toFixed(2)).join(', ')) : [members.map(() => '0.00').join(', ')];
            const sStr = `S = [\n  ${sRows.join(';\n   ')}\n]; % Matrika Porabe (S)`;
            const footerStr = `\n% IZRAƒåUN KONƒåNIH BILANC\nB = Z + sum(P, 1) - sum(S, 1);\nfprintf('\\n--- KONƒåNA STANJA (Obraƒçun) ---\\n');\nfor i = 1:length(clani)\n    fprintf('%s: %.2f ‚Ç¨\\n', clani{i}, B(i));\nend\nfprintf('\\n--- PREDLAGAN PORAƒåUN (Navodila za poravnavo) ---\\n');\nst_clanov = length(clani);\n[stanja, idx] = sort(B);\nupnik_kazalec = st_clanov;\ndolznik_kazalec = 1;\nwhile dolznik_kazalec < upnik_kazalec\n    if abs(stanja(dolznik_kazalec)) < 0.01, dolznik_kazalec = dolznik_kazalec + 1; continue; end\n    if abs(stanja(upnik_kazalec)) < 0.01, upnik_kazalec = upnik_kazalec - 1; continue; end\n    znesek = min(abs(stanja(dolznik_kazalec)), stanja(upnik_kazalec));\n    if znesek > 0\n        fprintf('%s -> %s: %.2f ‚Ç¨\\n', clani{idx(dolznik_kazalec)}, clani{idx(upnik_kazalec)}, znesek);\n        stanja(dolznik_kazalec) = stanja(dolznik_kazalec) + znesek;\n        stanja(upnik_kazalec) = stanja(upnik_kazalec) - znesek;\n    end\n    if abs(stanja(dolznik_kazalec)) < 0.01, dolznik_kazalec = dolznik_kazalec + 1; end\n    if abs(stanja(upnik_kazalec)) < 0.01, upnik_kazalec = upnik_kazalec - 1; end\nend\n`;
            return `${headerStr}\n${membersStr}\n\n${zStr}\n\n${pStr}\n\n${sStr}\n${footerStr}`; 
        };

        const StatisticsModal = ({ show, onClose, history }) => {
            const stats = React.useMemo(() => {
                const transactions = history.filter(e => e.type !== 'adjustment');
                if (transactions.length === 0) return null;
                const totalSpend = transactions.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const totalParticipations = transactions.reduce((sum, e) => sum + (e.participants?.length || 0), 0);
                const avgLunch = totalParticipations > 0 ? totalSpend / totalParticipations : 0;
                const maxReceipt = Math.max(...transactions.map(e => parseFloat(e.amount) || 0));
                const bigSpender = transactions.find(e => parseFloat(e.amount) === maxReceipt)?.payer;
                const dayNames = ["Nedelja", "Ponedeljek", "Torek", "Sreda", "ƒåetrtek", "Petek", "Sobota"];
                const daySums = [0, 0, 0, 0, 0, 0, 0];
                transactions.forEach(e => { const day = new Date(e.date).getDay(); daySums[day] += (parseFloat(e.amount) || 0); });
                const maxDayIdx = daySums.indexOf(Math.max(...daySums));
                const milestones = [
                    { val: 20, label: "Zaboj kave", icon: "‚òï" },
                    { val: 50, label: "Nekaj pic za ekipo", icon: "üçï" },
                    { val: 100, label: "Poln tank goriva", icon: "‚õΩ" },
                    { val: 250, label: "Po≈°teno veƒçerjo s steak-i", icon: "ü•©" },
                    { val: 450, label: "Povratni let v New York", icon: "‚úàÔ∏è" },
                    { val: 650, label: "Najnovej≈°i pametni telefon", icon: "üì±" },
                    { val: 850, label: "Gaming konzolo", icon: "üéÆ" },
                    { val: 1050, label: "Vrhunsko gorsko kolo", icon: "üö≤" },
                    { val: 1300, label: "Elektriƒçni skiro", icon: "üõ¥" },
                    { val: 1500, label: "Rabljen avto (Golf 2 style)", icon: "üöó" }
                ];
                const currentMilestoneIdx = milestones.findIndex(m => totalSpend < m.val);
                const progressMilestone = currentMilestoneIdx === -1 ? milestones[milestones.length-1] : milestones[currentMilestoneIdx];
                const progressPercent = Math.min((totalSpend / 1500) * 100, 100);
                return { totalSpend, avgLunch, maxReceipt, bigSpender, bestDay: dayNames[maxDayIdx], bestDayVal: daySums[maxDayIdx], progressPercent, progressMilestone, mealCount: transactions.length };
            }, [history]);
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/90 z-[80] flex items-center justify-center p-4 backdrop-blur-md animate-fade-in no-print">
                    <div className="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="p-6 bg-[#002f55] text-white flex justify-between items-center shrink-0">
                            <h2 className="text-xl font-black flex items-center gap-2"><BarChart3 /> Statistika</h2>
                            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors"><X /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar space-y-6">
                            {!stats ? <div className="text-center py-10 text-slate-400 italic">Ni dovolj podatkov.</div> : (
                                <>
                                    <div className="bg-slate-50 p-5 rounded-3xl border border-slate-100 text-center">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Skupna poraba ekipe</p>
                                        <h3 className="text-3xl font-black text-[#002f55]">{stats.totalSpend.toFixed(2)} ‚Ç¨</h3>
                                    </div>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-end">
                                            <span className="text-xs font-bold text-slate-700">Pojedli smo za...</span>
                                            <span className="text-[10px] font-black text-[#002f55] bg-[#e4b00f] px-2 py-0.5 rounded uppercase">{stats.progressMilestone.label}</span>
                                        </div>
                                        <div className="h-4 bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                                            <div className="h-full bg-gradient-to-r from-[#002f55] to-[#e4b00f] transition-all duration-1000" style={{ width: `${stats.progressPercent}%` }}></div>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-50 p-4 rounded-3xl border border-emerald-100 flex items-center gap-3">
                                        <div className="bg-emerald-500 text-white p-2 rounded-2xl"><Calendar size={20} /></div>
                                        <div><h4 className="text-xs font-black text-emerald-900 uppercase">Najdra≈æji dan</h4><p className="text-sm font-bold text-emerald-700">{stats.bestDay} ({stats.bestDayVal.toFixed(0)} ‚Ç¨)</p></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-center">
                                        <div className="p-4 bg-slate-50 rounded-3xl border border-slate-100"><p className="text-[9px] font-bold text-slate-400 uppercase mb-1">Povpreƒçna malica</p><p className="text-lg font-black text-[#002f55]">{stats.avgLunch.toFixed(2)} ‚Ç¨</p></div>
                                        <div className="p-4 bg-slate-50 rounded-3xl border border-slate-100"><p className="text-[9px] font-bold text-slate-400 uppercase mb-1">≈†tevilo obrokov</p><p className="text-lg font-black text-[#002f55]">{stats.mealCount}</p></div>
                                    </div>
                                    <div className="p-4 bg-rose-50 rounded-3xl border border-rose-100 flex items-center gap-3">
                                        <div className="bg-rose-500 text-white p-2 rounded-2xl"><TrendingDown size={20} /></div>
                                        <div><h4 className="text-xs font-black text-rose-900 uppercase">Najveƒçji raƒçun</h4><p className="text-sm font-bold text-rose-700">{stats.maxReceipt.toFixed(2)} ‚Ç¨ ({stats.bigSpender})</p></div>
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="p-6 bg-slate-50 shrink-0"><button onClick={onClose} className="w-full py-4 bg-[#002f55] text-white rounded-2xl font-black text-sm shadow-xl uppercase">Zapri</button></div>
                    </div>
                </div>
            );
        };

        const RouletteModal = ({ members, balances, show, onClose }) => {
            const [currentName, setCurrentName] = React.useState("Kdo bo?");
            const [isSpinning, setIsSpinning] = React.useState(false);
            const [winner, setWinner] = React.useState(null);
            React.useEffect(() => { if (show) { setWinner(null); setCurrentName("Pritisni START"); setIsSpinning(false); } }, [show]);
            const selectWeightedWinner = () => {
                const maxBal = Math.max(...Object.values(balances));
                const weightedMembers = [];
                members.forEach(m => { const bal = balances[m] || 0; const weight = Math.floor((maxBal - bal) + 10); for(let i=0; i<weight; i++) weightedMembers.push(m); });
                return weightedMembers.length === 0 ? members[Math.floor(Math.random() * members.length)] : weightedMembers[Math.floor(Math.random() * weightedMembers.length)];
            };
            const startSpin = () => {
                if (isSpinning) return;
                setIsSpinning(true); setWinner(null);
                const finalWinner = selectWeightedWinner();
                let speed = 50; let counter = 0; const maxSteps = 40; 
                const spinInterval = () => {
                    setCurrentName(members[Math.floor(Math.random() * members.length)]);
                    counter++;
                    if (counter < maxSteps) { if (counter > maxSteps - 10) speed += 30; setTimeout(spinInterval, speed); } 
                    else { setCurrentName(finalWinner); setWinner(finalWinner); setIsSpinning(false); }
                };
                spinInterval();
            };
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/90 z-[70] flex items-center justify-center p-6 backdrop-blur-md animate-fade-in no-print">
                    <div className="w-full max-w-sm text-center relative">
                        <button onClick={onClose} className="absolute -top-12 right-0 text-white/50 hover:text-white"><X size={32} /></button>
                        <div className="mb-8"><Dices size={64} className={`mx-auto text-[#e4b00f] ${isSpinning ? 'animate-bounce' : ''}`} /><h2 className="text-2xl font-black text-white mt-4 uppercase tracking-widest">Kdo Plaƒça?</h2><p className="text-white/50 text-xs">Ute≈æen ≈æreb: Veƒçji dolg = Veƒçja smola</p></div>
                        <div className="bg-white rounded-3xl p-8 shadow-[0_0_50px_rgba(228,176,15,0.3)] border-4 border-[#e4b00f] relative overflow-hidden">
                            <div className="h-24 flex items-center justify-center overflow-hidden"><div className={`text-4xl font-black text-[#002f55] transition-all ${winner ? 'scale-125' : ''}`}>{currentName}</div></div>
                        </div>
                        {!isSpinning && !winner && <button onClick={startSpin} className="mt-8 w-full bg-[#e4b00f] text-[#002f55] py-4 rounded-2xl font-black text-xl shadow-xl">ZAVRTI üé≤</button>}
                        {winner && <div className="mt-8 space-y-3"><div className="text-white text-lg font-bold animate-bounce">üéä {winner} ƒçast√≠! üéä</div><button onClick={startSpin} className="w-full bg-[#002f55] border-2 border-[#e4b00f] text-[#e4b00f] py-3 rounded-xl font-bold uppercase">Ponovi</button></div>}
                    </div>
                </div>
            );
        };

        const AdminModal = ({ show, pin, setPin, error, pendingAction, onConfirm, onCancel }) => {
            if (!show) return null;
            const isEditing = pendingAction?.type === 'ADD' || pendingAction?.type === 'ADD_MEMBER';
            const isBlur = pendingAction?.type === 'TOGGLE_BLUR';
            return (
                <div className="fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in no-print">
                    <div className="bg-white p-6 rounded-3xl w-full max-w-xs shadow-2xl border-2 border-slate-100 text-center">
                        <div className="flex justify-center mb-4"><div className="bg-[#002f55]/10 p-3 rounded-full text-[#002f55]"><Lock size={32} /></div></div>
                        <h3 className="text-xl font-black text-slate-800 mb-2">Varnostna koda</h3>
                        <p className="text-slate-500 text-xs mb-4">{isBlur ? 'Za preklop zasebnosti potrebuje≈° ADMIN PIN.' : (isEditing ? 'Potrebna koda za urejanje.' : 'Potreben administratorski PIN.')}</p>
                        <input type="password" autoFocus value={pin} onChange={e => setPin(e.target.value)} onKeyDown={e => e.key === 'Enter' && onConfirm()} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full bg-slate-100 border-2 border-slate-200 rounded-xl py-3 text-center text-2xl font-bold tracking-widest outline-none focus:border-[#e4b00f] mb-2" />
                        {error && <p className="text-rose-500 text-xs font-bold mb-4 animate-bounce">Napaƒçna koda!</p>}
                        <div className="flex gap-2 mt-4"><button onClick={onCancel} className="flex-1 py-3 text-slate-400 font-bold bg-slate-50 rounded-xl">Prekliƒçi</button><button onClick={onConfirm} className="flex-1 py-3 bg-[#002f55] text-white font-bold rounded-xl">Potrdi</button></div>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = React.useState(null);
            const [isAuthenticated, setIsAuthenticated] = React.useState(false);
            const [inputCode, setInputCode] = React.useState('');
            const [authError, setAuthError] = React.useState(false);
            const [members, setMembers] = React.useState([]);
            const [history, setHistory] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [globalSettings, setGlobalSettings] = React.useState({ isBlurred: false });
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [showAddMember, setShowAddMember] = React.useState(false);
            const [newMemberName, setNewMemberName] = React.useState('');
            const [showResetConfirm, setShowResetConfirm] = React.useState(false);
            const [entryToDelete, setEntryToDelete] = React.useState(null);
            const [showAdminAuth, setShowAdminAuth] = React.useState(false);
            const [adminPinInput, setAdminPinInput] = React.useState('');
            const [pendingAction, setPendingAction] = React.useState(null);
            const [adminAuthError, setAdminAuthError] = React.useState(false);
            const [isResetting, setIsResetting] = React.useState(false);
            const [matrixType, setMatrixType] = React.useState('P');
            const [manualStartBalances, setManualStartBalances] = React.useState({});
            const [amount, setAmount] = React.useState('');
            const [payer, setPayer] = React.useState('');
            const [selectedParticipants, setSelectedParticipants] = React.useState([]);
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [splitType, setSplitType] = React.useState('equal');
            const [manualAmounts, setManualAmounts] = React.useState({});
            const [showRoulette, setShowRoulette] = React.useState(false);
            const [showStats, setShowStats] = React.useState(false);

            React.useEffect(() => {
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (e) { console.error(e); } };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            React.useEffect(() => {
                if (!user) return;
                const membersRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
                const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');

                const unsubSettings = onSnapshot(settingsRef, (docSnap) => { if (docSnap.exists()) setGlobalSettings(docSnap.data()); else setDoc(settingsRef, { isBlurred: false }); });
                const unsubMembers = onSnapshot(membersRef, (snapshot) => {
                    const mList = snapshot.docs.map(doc => doc.data().name);
                    if (mList.length === 0 && loading) {
                        const defaults = ["Martin", "Mitja", "Pavel", "Matej", "Zala", "Stela"];
                        defaults.forEach(n => setDoc(doc(membersRef, n), { name: n }));
                    } else setMembers(mList);
                });
                const unsubHistory = onSnapshot(historyRef, (snapshot) => {
                    const hList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    hList.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    setHistory(hList); setLoading(false);
                });
                return () => { unsubMembers(); unsubHistory(); unsubSettings(); };
            }, [user]);

            // KIRUR≈†KI POPRAVEK: Avtomatska izbira vseh se zgodi le ob prvem nalaganju
            React.useEffect(() => { 
                if (members.length > 0) { 
                    if (!payer || !members.includes(payer)) setPayer(members[0]); 
                    if (selectedParticipants.length === 0 && loading) setSelectedParticipants([...members]); 
                } 
            }, [members, loading]);

            const balances = React.useMemo(() => {
                const b = {}; members.forEach(m => b[m] = 0);
                history.forEach(entry => {
                    if (entry.user && !b.hasOwnProperty(entry.user)) b[entry.user] = 0;
                    if (entry.payer && !b.hasOwnProperty(entry.payer)) b[entry.payer] = 0;
                    if (entry.participants) entry.participants.forEach(p => { if (!b.hasOwnProperty(p)) b[p] = 0; });
                });
                history.forEach(entry => {
                    if (entry.type === 'adjustment') { b[entry.user] = money((b[entry.user] || 0) + entry.amount); return; }
                    const numAmount = parseFloat(entry.amount) || 0;
                    if (b.hasOwnProperty(entry.payer)) b[entry.payer] += numAmount;
                    if (entry.splitType === 'manual' && entry.manualAmounts) { Object.entries(entry.manualAmounts).forEach(([n, c]) => { if (b.hasOwnProperty(n)) b[n] -= (parseFloat(c) || 0); }); } 
                    else if (entry.participants) { const cp = numAmount / entry.participants.length; entry.participants.forEach(p => { if (b.hasOwnProperty(p)) b[p] -= cp; }); }
                });
                Object.keys(b).forEach(k => b[k] = money(b[k])); return b;
            }, [history, members]);

            const payerRanking = React.useMemo(() => [...members].sort((a, b) => (balances[a] || 0) - (balances[b] || 0)), [members, balances]);
            const titles = React.useMemo(() => calculateTitles(members, balances, history), [members, balances, history]);

            const isManualBalanced = React.useMemo(() => money(Object.values(manualAmounts).reduce((a, b) => a + (parseFloat(b) || 0), 0)) === money(parseFloat(amount) || 0), [manualAmounts, amount]);

            const verifyAdminPin = async () => {
                const pin = adminPinInput; const act = pendingAction?.type; let ok = false;
                if ((act === 'DELETE' || act === 'RESET' || act === 'TOGGLE_BLUR') && pin === ADMIN_PIN) ok = true;
                else if ((act === 'ADD' || act === 'ADD_MEMBER') && (pin === EDIT_CODE || pin === ADMIN_PIN)) ok = true;
                if (ok) {
                    setShowAdminAuth(false);
                    if (act === 'DELETE') await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', pendingAction.payload));
                    else if (act === 'RESET') { const init = {}; members.forEach(m => init[m] = 0); setManualStartBalances(init); setShowResetConfirm(true); }
                    else if (act === 'ADD') {
                        const data = { date, payer, amount: parseFloat(amount), participants: [...selectedParticipants], splitType, timestamp: Date.now(), opis: document.getElementById('opis-input')?.value || 'Malica' };
                        if (splitType === 'manual') data.manualAmounts = { ...manualAmounts };
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), data); setAmount(''); setManualAmounts({}); setActiveTab('history');
                    }
                    else if (act === 'ADD_MEMBER') { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', newMemberName.trim()), { name: newMemberName.trim() }); setNewMemberName(''); setShowAddMember(false); }
                    else if (act === 'TOGGLE_BLUR') await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { isBlurred: !globalSettings.isBlurred });
                    setPendingAction(null);
                } else setAdminAuthError(true);
            };

            const finalizeReset = async () => {
                setIsResetting(true);
                const hRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
                const snap = await getDocs(hRef); const batch = writeBatch(db);
                snap.docs.forEach(d => batch.delete(d.ref));
                for (const [n, v] of Object.entries(manualStartBalances)) {
                    if (Math.abs(parseFloat(v)) < 0.01) continue;
                    batch.set(doc(hRef), { type: 'adjustment', user: n, amount: parseFloat(v), timestamp: Date.now(), date: new Date().toISOString().split('T')[0], opis: 'Zaƒçetno stanje' });
                }
                await batch.commit(); setIsResetting(false); setShowResetConfirm(false); setActiveTab('dashboard');
            };

            if (!isAuthenticated) return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-white"><div className="max-w-xs w-full text-center space-y-8 animate-fade-in"><div className="inline-flex p-4 bg-[#002f55] rounded-3xl border-2 border-[#e4b00f]"><Lock size={48} /></div><h1 className="text-3xl font-black">Malica Manager</h1><div className="space-y-4"><input type="password" value={inputCode} onChange={e => setInputCode(e.target.value)} onKeyDown={e => e.key === 'Enter' && (inputCode === ACCESS_CODE ? setIsAuthenticated(true) : setAuthError(true))} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full bg-slate-800 border-2 border-slate-700 rounded-2xl py-4 text-center text-3xl font-bold tracking-[1em] outline-none" /><button onClick={() => inputCode === ACCESS_CODE ? setIsAuthenticated(true) : setAuthError(true)} className="w-full bg-[#002f55] text-[#e4b00f] py-4 rounded-2xl font-black">ODKLENI</button></div></div></div>
            );
            if (loading) return <div className="min-h-screen flex items-center justify-center"><RefreshCcw className="animate-spin text-[#002f55]" /></div>;

            return (
                <div className="min-h-screen bg-slate-50 pb-24 font-sans app-container">
                    <AdminModal show={showAdminAuth} pin={adminPinInput} setPin={setAdminPinInput} error={adminAuthError} pendingAction={pendingAction} onConfirm={verifyAdminPin} onCancel={() => setShowAdminAuth(false)} />
                    <StatisticsModal show={showStats} onClose={() => setShowStats(false)} history={history} />
                    <RouletteModal members={members} balances={balances} show={showRoulette} onClose={() => setShowRoulette(false)} />
                    
                    <header className="bg-[#002f55] text-white p-6 rounded-b-[2.5rem] shadow-xl mb-6 text-center no-print">
                        <h1 className="text-2xl font-bold flex items-center justify-center gap-2"><Wallet className="text-[#e4b00f]" /> Malica Manager</h1>
                    </header>

                    <main className="max-w-md mx-auto px-4 no-print">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="bg-white p-6 rounded-3xl shadow-lg text-center relative border border-white">
                                    <button onClick={() => { setPendingAction({type:'TOGGLE_BLUR'}); setAdminPinInput(''); setShowAdminAuth(true); }} className="absolute top-4 right-4 text-slate-300 hover:text-[#002f55]"><Eye size={18} /></button>
                                    <p className="text-slate-400 text-xs font-bold uppercase mb-2">Naslednji plaƒça</p>
                                    <h2 className={`text-4xl font-black text-[#002f55] mb-2 ${globalSettings.isBlurred ? 'blur-lg select-none' : ''}`}>{payerRanking[0] || "Dodaj ƒçlana"}</h2>
                                    <div className={`inline-flex items-center gap-2 bg-[#002f55]/5 px-4 py-1.5 rounded-full text-sm font-bold ${globalSettings.isBlurred ? 'blur-md' : ''}`}>Bilanca: {balances[payerRanking[0]]?.toFixed(2)} ‚Ç¨</div>
                                </div>
                                <div className="bg-white rounded-3xl shadow-sm overflow-hidden">
                                    <div className="p-4 border-b bg-slate-50 flex items-center gap-2"><ListOrdered size={18} /> Vrstni red</div>
                                    <div className={`divide-y ${globalSettings.isBlurred ? 'blur-lg select-none' : ''}`}>
                                        {payerRanking.map((m, i) => (<div key={m} className="p-4 flex justify-between items-center"><div className="flex items-center gap-3"><span className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold">{i+1}</span><span className="font-bold">{m}</span></div><span className={`font-bold ${balances[m]>=0?'text-emerald-600':'text-rose-500'}`}>{balances[m].toFixed(2)} ‚Ç¨</span></div>))}
                                    </div>
                                </div>
                                <button onClick={() => setShowRoulette(true)} className="w-full py-4 bg-[#e4b00f] text-[#002f55] font-black text-lg rounded-2xl flex items-center justify-center gap-2 shadow-lg">Dices Kdo Plaƒça? üé≤</button>
                                <div className="grid grid-cols-2 gap-3"><button onClick={() => setShowStats(true)} className="w-full py-3 bg-[#002f55]/5 text-[#002f55] font-bold rounded-2xl flex items-center justify-center gap-2 border border-[#002f55]/10"><BarChart3 size={18} /> Statistika</button><button onClick={() => setActiveTab('matrix')} className="w-full bg-[#002f55] text-white py-3 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg"><Grid size={18} /> Matrike</button></div>
                            </div>
                        )}
                        {activeTab === 'add' && (
                            <div className="bg-white p-6 rounded-3xl shadow-sm border space-y-6">
                                <h3 className="text-xl font-bold flex items-center gap-2"><PlusCircle className="text-[#002f55]" /> Nov raƒçun</h3>
                                <form onSubmit={e => { e.preventDefault(); setPendingAction({type:'ADD'}); setAdminPinInput(''); setShowAdminAuth(true); }} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="text" id="opis-input" placeholder="Opis..." className="w-full p-3 bg-slate-50 rounded-xl outline-none" required />
                                        <input type="number" step="0.01" value={amount} onChange={e => setAmount(e.target.value)} placeholder="Znesek ‚Ç¨" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" required />
                                    </div>
                                    <select value={payer} onChange={e => setPayer(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-[#002f55] outline-none">{members.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                    
                                    {/* KIRUR≈†KO DODAN GUMB VSI IN MANUAL LOGIKA */}
                                    <div className="flex bg-slate-100 p-1 rounded-2xl gap-1">
                                        <button type="button" onClick={() => setSplitType('equal')} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${splitType === 'equal' ? 'bg-white shadow-sm text-[#002f55]' : 'text-slate-400'}`}>Enakomerno</button>
                                        <button type="button" onClick={() => setSplitType('manual')} className={`flex-1 py-2 rounded-xl text-xs font-bold transition-all ${splitType === 'manual' ? 'bg-white shadow-sm text-[#002f55]' : 'text-slate-400'}`}>Po porabi</button>
                                    </div>

                                    <div className="flex justify-end px-1">
                                        <button type="button" onClick={() => setSelectedParticipants(selectedParticipants.length === members.length ? [] : [...members])} className="text-xs font-bold text-[#002f55] flex items-center gap-2 py-2">
                                            {selectedParticipants.length === members.length ? <CheckSquare size={18} /> : <Square size={18} />}
                                            <span className="uppercase tracking-wider">Vsi</span>
                                        </button>
                                    </div>

                                    <div className="space-y-2">
                                        {members.map(m => {
                                            const sel = selectedParticipants.includes(m);
                                            return (
                                                <div key={m} onClick={() => setSelectedParticipants(p => p.includes(m) ? p.filter(x => x !== m) : [...p, m])} className={`p-3 rounded-xl border transition-all flex items-center gap-3 cursor-pointer ${sel ? 'bg-[#002f55]/5 border-[#002f55]/20' : 'opacity-40'}`}>
                                                    <span className="flex-1 text-sm font-bold">{m}</span>
                                                    {splitType === 'manual' && sel ? (
                                                        <input type="number" step="0.01" placeholder="0.00" value={manualAmounts[m] || ''} onChange={e => { e.stopPropagation(); setManualAmounts({...manualAmounts, [m]: e.target.value}); }} className="w-20 p-1 bg-white border rounded text-right text-xs font-bold" />
                                                    ) : (sel && <CheckCircle2 size={16} className="text-[#002f55]" />)}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    {splitType === 'manual' && (
                                        <div className={`p-3 rounded-xl text-center text-xs font-bold ${isManualBalanced ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                                            Vsota: {Object.values(manualAmounts).reduce((a, b) => a + (parseFloat(b) || 0), 0).toFixed(2)} ‚Ç¨ / {parseFloat(amount || 0).toFixed(2)} ‚Ç¨
                                        </div>
                                    )}
                                    <button type="submit" disabled={!amount || selectedParticipants.length === 0 || (splitType === 'manual' && !isManualBalanced)} className="w-full bg-[#002f55] text-white py-4 rounded-2xl font-black shadow-xl uppercase disabled:opacity-30">Shrani raƒçun</button>
                                </form>
                            </div>
                        )}
                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-fade-in"><h3 className="text-xl font-bold flex items-center gap-2 px-2"><History className="text-[#002f55]" /> Zgodovina</h3><div className="space-y-3">{history.map(e => { const isAdj = e.type === 'adjustment'; return (<div key={e.id} className="bg-white p-4 rounded-2xl shadow-sm border flex justify-between items-start"><div className="flex gap-3"><div className="bg-slate-50 w-10 h-10 rounded-xl flex items-center justify-center flex-col text-slate-400 font-bold text-[8px] uppercase">{new Date(e.date).getDate()}<span>{new Date(e.date).toLocaleString('sl', {month:'short'})}</span></div><div><p className="text-sm font-bold text-slate-700">{isAdj?e.user:e.payer} <span className="text-xs font-normal text-slate-400">{isAdj?'prenos stanja':'je plaƒçal/a'}</span></p><span className="text-[10px] text-slate-500">{e.opis}</span></div></div><div className="text-right"><p className="font-black text-slate-800">{e.amount.toFixed(2)} ‚Ç¨</p><button onClick={() => { setPendingAction({type:'DELETE', payload:e.id}); setAdminPinInput(''); setShowAdminAuth(true); }} className="text-rose-200 mt-1"><Trash2 size={16} /></button></div></div>); })}</div></div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t px-6 py-2 pb-safe shadow-2xl no-print z-50">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center p-2 ${activeTab==='dashboard'?'text-[#002f55]':'text-slate-400'}`}><TrendingDown size={22} /><span className="text-[10px] mt-1 font-bold">Stanje</span></button>
                            <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center p-2 ${activeTab==='history'?'text-[#002f55]':'text-slate-400'}`}><History size={22} /><span className="text-[10px] mt-1 font-bold">Zgodovina</span></button>
                            <div className="relative -top-8"><button onClick={() => setActiveTab('add')} className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl bg-[#002f55] border-4 border-white text-[#e4b00f]`}><PlusCircle size={32} /></button></div>
                            <button onClick={() => window.print()} className="flex flex-col items-center p-2 text-slate-400"><Printer size={22} /><span className="text-[10px] mt-1 font-bold">Izvozi</span></button>
                            <button onClick={() => setActiveTab('dashboard')} className="flex flex-col items-center p-2 text-slate-400"><Users size={22} /><span className="text-[10px] mt-1 font-bold">Ekipa</span></button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
